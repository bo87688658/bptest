<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>BP Offline / Online</title>
<link rel="icon" type="image/x-icon" href="icon.png">

<!-- PeerJS -->
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>

<style>
@font-face {
    font-family: 'cpBurbankSmall';
    src: url('assets/cpBurbankSmall.ttf') format('truetype');
}

body {
    margin:0;
    font-family:'cpBurbankSmall',Arial,sans-serif;
    overflow:hidden;
    background: radial-gradient(circle, rgba(46,71,170,1) 0%, rgba(23,35,85,1) 100%);
    color:white;
}

canvas {
    display:block;
    background:#1e90ff;
}

/* Telas */
.tela {
    position:absolute;
    top:0;left:0;
    width:100%;height:100%;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    background: radial-gradient(circle, rgba(46,71,170,1) 0%, rgba(23,35,85,1) 100%);
    z-index:20;
}

.tela input, .tela button {
    margin:8px;
    padding:10px;
    font-size:18px;
    border-radius:6px;
    border:none;
    font-family:'cpBurbankSmall',Arial,sans-serif;
}

.tela button {
    cursor:pointer;
    background:#1e90ff;
    color:white;
    font-weight:bold;
}

.loader {
    width:100px;
    height:100px;
    background: url('assets/load.png') no-repeat center center;
    background-size:contain;
    filter: brightness(0) invert(1);
    animation: rotate 2s ease-in-out infinite;
}

@keyframes rotate {
    0%{transform:rotate(0deg);}
    50%{transform:rotate(180deg);}
    100%{transform:rotate(360deg);}
}

.loading-text {
    margin-top:25px;
    font-size:26px;
    letter-spacing:1px;
}

.dots::after {
    content:'.';
    animation:dots 1.5s infinite;
}

@keyframes dots {
    0%{content:'.';}
    33%{content:'..';}
    66%{content:'...';}
    100%{content:'.';}
}
</style>
</head>
<body>

<!-- 1️⃣ Tela Username + Cor -->
<div id="usernameScreen" class="tela">
    <h2>Escolha seu username e cor</h2>
    <input type="text" id="usernameInput" placeholder="Digite seu username">
    <input type="color" id="colorPicker" value="#ff0000">
    <button id="nextButton">Próximo</button>
</div>

<!-- 2️⃣ Tela Modo -->
<div id="modeScreen" class="tela" style="display:none;">
    <h2>Escolha o modo</h2>
    <button id="offlineBtn">Offline</button>
    <button id="onlineBtn">Online</button>
</div>

<!-- 3️⃣ Tela Online -->
<div id="onlineScreen" class="tela" style="display:none;">
    <input type="text" id="peerIdInput" placeholder="Digite um ID ou deixe em branco para gerar">
    <button id="createServerBtn">Criar Servidor</button>
    <button id="joinServerBtn">Entrar em Servidor</button>
</div>

<!-- Loader -->
<div id="loaderScreen" class="tela" style="display:none;">
    <div class="loader"></div>
    <div class="loading-text">Loading<span class="dots"></span></div>
</div>

<!-- Canvas do jogo -->
<canvas id="game" width="1000" height="632"></canvas>

<!-- Música -->
<audio id="bgMusic" src="assets/town.mp3" loop></audio>

<!-- Scripts do jogo -->
<script src="peer.js"></script>
<script src="assets/penguin.js"></script>
<script src="assets/towncollision.js"></script>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const bgMusic = document.getElementById("bgMusic");

// Sprites
const imgBase = new Image();
imgBase.src = "assets/penguin_base.png";
const imgColor = new Image();
imgColor.src = "assets/penguin_color.png";
const mapImg = new Image();
mapImg.src = "assets/towntest.png";

let username = "";
let usernameColor = "#ff0000";
let state="idle", frameIndex=0, frameTimer=0;

// Pinguim
const penguin={x:400,y:250,targetX:400,targetY:250,speed:2.5,suffix:270,flip:false};
let mouseX=400, mouseY=250;

// Mouse
canvas.addEventListener("mousemove", e=>{
    const rect = canvas.getBoundingClientRect();
    mouseX = e.clientX - rect.left;
    mouseY = e.clientY - rect.top;
});
canvas.addEventListener("click", e=>{
    const rect = canvas.getBoundingClientRect();
    penguin.targetX = e.clientX - rect.left;
    penguin.targetY = e.clientY - rect.top;
    state="walk";
});

// Telas
const usernameScreen = document.getElementById("usernameScreen");
const modeScreen = document.getElementById("modeScreen");
const onlineScreen = document.getElementById("onlineScreen");
const loaderScreen = document.getElementById("loaderScreen");
// PeerJS
let isOnline=false, peer, conn;

document.getElementById("nextButton").onclick = ()=>{
    username = document.getElementById("usernameInput").value || "Player";
    usernameColor = document.getElementById("colorPicker").value;
    usernameScreen.style.display="none";
    modeScreen.style.display="flex";
};

// 2️⃣ Escolha do modo
document.getElementById("offlineBtn").onclick = () => {
    modeScreen.style.display="none";
    startGame();
};

document.getElementById("onlineBtn").onclick = () => {
    modeScreen.style.display="none";
    onlineScreen.style.display="flex";
    isOnline = true;
};

// 3️⃣ Online
document.getElementById("createServerBtn").onclick = () => {
    const id = document.getElementById("peerIdInput").value || undefined;
    peer = new Peer(id, {
        host: '0.peerjs.com', // ou use um servidor próprio
        port: 443,
        secure: true
    });

    peer.on('open', id => {
        alert(`Servidor criado! Seu ID: ${id}`);
        onlineScreen.style.display = "none";
        startGame();
    });

    peer.on('connection', c => {
        conn = c;
        setupConnection(conn);
        alert(`Novo jogador conectado: ${c.peer}`);
    });

    peer.on('error', err => {
        console.log("PeerJS Error:", err);
        alert("Erro ao criar servidor. Tente outro ID.");
    });
};

document.getElementById("joinServerBtn").onclick = () => {
    const serverId = document.getElementById("peerIdInput").value;
    if(!serverId) return alert("Digite o ID do servidor!");
    peer = new Peer(); // gera um ID aleatório
    conn = peer.connect(serverId);

    conn.on('open', () => {
        alert("Conectado ao servidor!");
        onlineScreen.style.display = "none";
        startGame();
    });

    conn.on('data', data => {
        console.log("Recebeu do servidor:", data);
        // aqui você pode atualizar pinguins online, chat etc.
    });

    conn.on('error', err => {
        console.log("Conexão PeerJS Error:", err);
        alert("Erro ao conectar ao servidor.");
    });

    setupConnection(conn);
};

function setupConnection(c) {
    c.on('data', data => {
        console.log("Recebeu:", data);
        // Aqui você pode atualizar pinguins online ou chat
    });
}

// Cor e chat
document.getElementById("colorPicker").addEventListener("input", e=>usernameColor=e.target.value);

const chatInput = document.createElement("input");
chatInput.type="text";
chatInput.placeholder="Digite uma mensagem...";
chatInput.style.position="absolute";
chatInput.style.bottom="20px";
chatInput.style.left="50%";
chatInput.style.transform="translateX(-50%)";
chatInput.style.width="300px";
chatInput.style.padding="10px";
chatInput.style.borderRadius="12px 12px 0 0";
chatInput.style.border="2px solid #888";
chatInput.style.fontFamily="'cpBurbankSmall',Arial,sans-serif";
chatInput.style.fontSize="16px";
chatInput.style.outline="none";
chatInput.style.background="rgba(0,0,0,0.6)";
chatInput.style.color="white";
document.body.appendChild(chatInput);

let chatMessage="", chatTimer=0;
chatInput.addEventListener("keydown", e=>{
    if(e.key==="Enter" && chatInput.value.trim()!==""){
        chatMessage = chatInput.value.trim();
        chatInput.value="";
        chatTimer = 200;
    }
});
function drawChatBubble(){
    if(!chatMessage || chatTimer<=0) return;
    chatTimer--;
    const bubbleWidth = ctx.measureText(chatMessage).width + 20;
    const bubbleHeight = 30;
    const bubbleX = penguin.x - bubbleWidth/2;
    const bubbleY = penguin.y - 30;
    ctx.save();
    ctx.fillStyle="rgba(255,255,255,0.9)";
    ctx.strokeStyle="#888";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.roundRect(bubbleX,bubbleY,bubbleWidth,bubbleHeight,10);
    ctx.fill();
    ctx.stroke();
    ctx.fillStyle="#000";
    ctx.font="16px cpBurbankSmall, sans-serif";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(chatMessage,penguin.x,bubbleY+bubbleHeight/2);
    ctx.restore();
}

// Funções do jogo
function drawShadow(){
    const shadowX=penguin.x, shadowY=penguin.y+50;
    ctx.save();
    ctx.translate(shadowX,shadowY);
    ctx.fillStyle="rgba(0,0,0,0.5)";
    ctx.filter="blur(8px)";
    ctx.beginPath();
    ctx.ellipse(0,0,30,12,0,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
}

function calculateDirection(dx,dy){
    const absX=Math.abs(dx), absY=Math.abs(dy);
    penguin.flip = dx<0;
    if(absX>absY*1.3) return 180;
    if(absY>absX*1.3) return dy>0?270:90;
    return dy>0?225:135;
}

function update(){
    const dx=penguin.targetX-penguin.x;
    const dy=penguin.targetY-penguin.y;
    const dist=Math.hypot(dx,dy);
    if(dist>2){
        const moveX = dx/dist*penguin.speed;
        const moveY = dy/dist*penguin.speed;
        const nextX = penguin.x + moveX;
        const nextY = penguin.y + moveY;
        const gridNextX = Math.floor(nextX/50);
        const gridNextY = Math.floor(nextY/50);
        if(touchableSquares.some(sq=>sq.x===gridNextX && sq.y===gridNextY)){
            penguin.x=nextX;
            penguin.y=nextY;
            penguin.suffix = calculateDirection(dx,dy);
            state="walk";
            frameTimer++;
            if(frameTimer>3){frameIndex++;frameTimer=0;}
        } else {
            penguin.targetX=penguin.x;
            penguin.targetY=penguin.y;
            state="idle"; frameIndex=0;
        }
    } else {
        state="idle"; frameIndex=0;
        const lookDX = mouseX - penguin.x;
        const lookDY = mouseY - penguin.y;
        penguin.suffix = calculateDirection(lookDX,lookDY);
    }
    const frames = window.PenguinData[state].filter(f=>f.suffix===penguin.suffix);
    if(frameIndex>=frames.length) frameIndex=0;
}

function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawShadow();
    if(mapImg.complete) ctx.drawImage(mapImg,0,0);
    const frames = window.PenguinData[state].filter(f=>f.suffix===penguin.suffix);
    if(!frames.length) return;
    const frame = frames[frameIndex];
    const centerOffsetX = frame.w/2;
    const centerOffsetY = frame.h*0;
    const drawX = penguin.flip?-penguin.x-centerOffsetX:penguin.x-centerOffsetX;
    const drawY = penguin.y-centerOffsetY;
    ctx.save();
    if(penguin.flip) ctx.scale(-1,1);
    ctx.drawImage(imgBase,frame.x,frame.y,frame.w,frame.h,drawX,drawY,frame.w,frame.h);

    const tmpCanvas = document.createElement("canvas");
    tmpCanvas.width = frame.w; tmpCanvas.height = frame.h;
    const tmpCtx = tmpCanvas.getContext("2d");
    tmpCtx.drawImage(imgColor,frame.x,frame.y,frame.w,frame.h,0,0,frame.w,frame.h);
    tmpCtx.globalCompositeOperation="source-in";
    tmpCtx.fillStyle=usernameColor;
    tmpCtx.fillRect(0,0,frame.w,frame.h);
    ctx.drawImage(tmpCanvas,drawX,drawY);
    ctx.restore();

    ctx.font="18px cpBurbankSmall, sans-serif";
    ctx.textAlign="center";
    ctx.lineWidth=4;
    ctx.strokeStyle="black";
    ctx.fillStyle="white";
    ctx.strokeText(username,penguin.x,penguin.y+frame.h/2+50);
    ctx.fillText(username,penguin.x,penguin.y+frame.h/2+50);
}

function gameLoop(){
    update();
    draw();
    drawChatBubble();
    requestAnimationFrame(gameLoop);
}

// Inicia o jogo (loader + loop)
function startGame(){
    loaderScreen.style.display="flex";
    let loadedCount=0;
    const onLoad = ()=>{
        loadedCount++;
        if(loadedCount===2){
            loaderScreen.style.display="none";
            gameLoop();
            bgMusic.volume=0.5;
            bgMusic.play().catch(err=>console.log("Autoplay impedido:",err));
        }
    };
    imgBase.onload = onLoad;
    imgColor.onload = onLoad;
    if(imgBase.complete && imgColor.complete) onLoad(),onLoad();
}
</script>
</body>
</html>

